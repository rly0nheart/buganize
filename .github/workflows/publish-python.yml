# This workflow will upload a Python Package to PyPI and create a GitHub release when pushing to master
# For more information see: https://docs.github.com/en/actions/automating-builds-and-tests/building-and-testing-python#publishing-to-package-registries

name: Upload Python Package

permissions:
  contents: write
  id-token: write

on:
  push:
    branches: [ master ]

jobs:
  publish:
    runs-on: ubuntu-latest

    environment:
      name: pypi
      url: https://pypi.org/p/buganize

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.x"

      - name: Get package info
        id: pkg
        run: |
          VERSION=$(python -c "import tomllib; print(tomllib.load(open('pyproject.toml', 'rb'))['project']['version'])")
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Found version $VERSION"

      - name: Check PyPI
        id: check_pypi
        run: |
          VERSION=${{ steps.pkg.outputs.version }}
          if curl -s "https://pypi.org/pypi/buganize/$VERSION/json" | grep -q '"message": "Not Found"'; then
            echo "Version $VERSION not found on PyPI, will publish"
            echo "publish=true" >> $GITHUB_OUTPUT
          else
            echo "Version $VERSION already exists on PyPI, skipping publish"
            echo "publish=false" >> $GITHUB_OUTPUT
          fi

      - name: Extract changelog
        if: steps.check_pypi.outputs.publish == 'true'
        id: changelog
        run: |
          VERSION=${{ steps.pkg.outputs.version }}

          NOTES=$(awk "
            /^## \[${VERSION}\]/ { found=1; next }
            /^## \[/ { if(found) exit }
            found { print }
          " CHANGELOG.md)

          if [ -z "$NOTES" ]; then
            NOTES="Released version ${VERSION}"
          fi

          echo "notes<<EOF" >> $GITHUB_OUTPUT
          echo "$NOTES" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Build release distributions
        if: steps.check_pypi.outputs.publish == 'true'
        run: |
          python -m pip install uv
          python -m uv build

      - name: Tag version
        if: steps.check_pypi.outputs.publish == 'true'
        run: |
          VERSION=${{ steps.pkg.outputs.version }}
          if git rev-parse "$VERSION" >/dev/null 2>&1 || git ls-remote --tags origin | grep -q "refs/tags/$VERSION$"; then
            echo "Tag $VERSION already exists, skipping"
            exit 0
          fi
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          git tag $VERSION
          git push origin $VERSION
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Create GitHub release
        if: steps.check_pypi.outputs.publish == 'true'
        run: |
          VERSION=${{ steps.pkg.outputs.version }}
          # Delete stale release from a previous failed run
          gh release delete "$VERSION" --yes --cleanup-tag 2>/dev/null || true
          gh release create "$VERSION" \
            --title "v${VERSION}" \
            --notes "${{ steps.changelog.outputs.notes }}" \
            --latest \
            dist/*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Publish to PyPI
        if: steps.check_pypi.outputs.publish == 'true'
        uses: pypa/gh-action-pypi-publish@release/v1
        with:
          packages-dir: dist/
